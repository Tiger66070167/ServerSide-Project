<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard</title>
  <link rel="stylesheet" href="/css/style.css">
  <link rel="stylesheet" href="/css/modal.css">
</head>
<body>
  <%- include('partials/header') %>

  <div class="dashboard-container">
    <div class="welcome-header">
      <h2>Welcome, <%= username %>!</h2>
      <button class="create-task-btn" onclick="openModal('/new')">+ Create Task</button>
    </div>

    <div class="filters-container">
      <form method="GET" action="/" class="filter-form">
        <div class="filter-group">
          <label for="status">Status:</label>
          <select name="status" id="status" onchange="this.form.submit()">
            <option value="All" <%= filter === 'All' ? 'selected' : '' %>>All</option>
            <option value="Pending" <%= filter === 'Pending' ? 'selected' : '' %>>Pending</option>
            <option value="In Progress" <%= filter === 'In Progress' ? 'selected' : '' %>>In Progress</option>
            <option value="Completed" <%= filter === 'Completed' ? 'selected' : '' %>>Completed</option>
          </select>
        </div>

        <div class="filter-group">
          <label for="category">Category:</label>
          <select name="category_id" id="category" onchange="this.form.submit()">
            <option value="">All</option>
            <% categories.forEach(cat => { %>
              <option value="<%= cat.category_id %>" <%= category_id == cat.category_id ? 'selected' : '' %>><%= cat.name %></option>
            <% }) %>
          </select>
        </div>

        <div class="filter-group">
          <label for="sort">Sort by:</label>
          <select name="sort" id="sort" onchange="this.form.submit()">
            <option value="">None</option>
            <option value="priority" <%= sort === 'priority' ? 'selected' : '' %>>Priority</option>
            <option value="due_date_asc" <%= sort === 'due_date_asc' ? 'selected' : '' %>>Due Date ↑</option>
            <option value="due_date_desc" <%= sort === 'due_date_desc' ? 'selected' : '' %>>Due Date ↓</option>
            <option value="az" <%= sort === 'az' ? 'selected' : '' %>>Title A-Z</option>
            <option value="za" <%= sort === 'za' ? 'selected' : '' %>>Title Z-A</option>
          </select>
        </div>
      </form>
    </div>

    <ul class="task-list">
      <% if (tasks && tasks.length > 0) { %>
        <% tasks.forEach(task => { %>
          <li class="task-item">
            <a href="/<%= task.task_id %>/board" class="task-link">
              <div class="task-details">
                <strong><%= task.title %></strong>
                <span class="task-status <%= task.status.toLowerCase().replace(' ', '-') %>"><%= task.status %></span>
                <span class="task-date">Created: <%= new Date(task.created_at).toLocaleString() %></span>
                <span class="task-due-date">Due: <%= task.due_date ? new Date(task.due_date).toLocaleString() : '' %></span>
              </div>
            </a>
            
            <div class="task-actions">
              <button class="edit-btn" onclick="openModal('/edit/<%= task.task_id %>')">Edit</button>
              <form method="POST" action="/softDeleteTask/<%= task.task_id %>" style="display:inline">
                <button type="submit" class="trash-btn" onclick="return confirm('Are you sure?')">Move to Trash</button>
              </form>
            </div>
          </li>
        <% }) %>
      <% } else { %>
        <li class="no-tasks">No tasks available.</li>
      <% } %>
    </ul>

    <div class="dashboard-links">
      <a href="/archive" class="dashboard-link">Archive</a>
    </div>
  </div>

  <%- include('partials/footer') %>

  <!-- Modal -->
  <div id="modalContainer" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeModal()">&times;</span>
      <div id="modalContent"></div>
    </div>
  </div>

  <script>
    async function openModal(url) {
      const res = await fetch(url);
      const html = await res.text();
      document.getElementById('modalContent').innerHTML = html;
      document.getElementById('modalContainer').style.display = 'block';
    }

    function closeModal() {
      document.getElementById('modalContainer').style.display = 'none';
    }

    window.onclick = function(event) {
      const modal = document.getElementById('modalContainer');
      if (event.target === modal) closeModal();
    }
  </script>
</body>
</html>
